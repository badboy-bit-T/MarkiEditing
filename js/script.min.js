$(document).ready(function(){const t=$("#popup");let e=null;const n=t=>t.toString().padStart(2,"0"),a=new Date,o=n(a.getHours()),i=n(a.getMinutes()),s=a.getFullYear(),r=n(a.getMonth()+1),c=n(a.getDate()),d=`${s}-${r}-${c}`,l=`${o}:${i}`,m=`${o}-${i}-${d}`,p=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"],u=(t=>{const e=new Date(t);return isNaN(e)?"Hari":p[e.getDay()]})(d),h=document.getElementById("animatedText");!function t(e,n,a){a<e.length?(n.textContent+=e.charAt(a),setTimeout(()=>t(e,n,a+1),80)):null}("Cukup 3 menit ",h,0),setTimeout(()=>{h.innerHTML+='<span>Laporanmu Siap Dibagikan ðŸ˜ŽâœŒ</span>'},3e3),$("#input-date").val(d),$("#input-time").val(l),$("#input-day").val(u),g($(".marki-box"),{time:l,date:d,day:u}),$("#input-date").on("change",function(){$("#input-day").val(((t)=>{const e=new Date(t);return isNaN(e)?"Hari":p[e.getDay()]})(this.value))}),$("#hidePetugas").on("change",function(){$(".handler-section").toggle(!$(this).is(":checked"))}),$("#upload").on("change",function(t){const a=t.target.files;if(!a.length)return;$("#animatedText").hide(),$("#output-container").empty(),$("#download-image").show(),$(".upload-label").css("right","50px"),Array.from(a).forEach(function(t,a){if(t.type.startsWith("image/")){const o=new FileReader;o.onload=function(o){const i=new Image;i.src=o.target.result,i.style.maxWidth="100%",i.style.display="block";const s=$('<div class="image-wrapper" style="position:relative; margin-bottom:15px;"></div>');s.attr("data-index",a).append(i);const r=$('<button class="per-image-download-btn" title="Download gambar ini" style="position: absolute; top: 10px; right: 10px; z-index: 10; background: darkgrey; color: black; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Download</button>');r.on("click",function(){!async function(t,e,n,a){let o;try{$("body").append(f),o=f.find(".spinner-text"),o.text("Memproses..."),n.hide(),t.style.display="none",t.offsetHeight,t.style.display="",await new Promise(t=>setTimeout(t,100));const i=await html2canvas(t,{useCORS:!0,backgroundColor:null}),s=await new Promise((t,e)=>{i.toBlob(e=>e?t(e):e(new Error("Gagal membuat blob")),"image/jpeg")});await new Promise(t=>setTimeout(t,300)),saveAs(s,`patroli_${e+1}_${a}.jpg`)}catch(t){console.error(t),alert("Terjadi kesalahan: "+t.message)}finally{n.show(),f.remove()}}(s[0],a,$(this),m)}),s.append(r);const c=$(".marki-box").clone().removeAttr("id").addClass("marki-box-clone").css({position:"absolute",bottom:"15px",left:"15px",zIndex:5,cursor:"pointer"});g(c,{date:d,time:l,day:u}),c.on("click",function(){e=$(this);const n=v(e);$("#input-time").val(n.time),$("#input-date").val(n.date),$("#input-day").val(n.day),$("#input-location").val(n.location),$("#input-handler").val(n.handler),t.css("display","flex")}),s.append(c),$("#output-container").append(s)},o.readAsDataURL(t)}})}),$("#apply-marki").on("click",function(){if(!e)return alert("Tidak ada watermark yang dipilih.");const n=y();g(e,n),$(".marki-box-clone .note-view, .marki-box .note-view").text(n.handler),t.hide(),e=null}),$("#cancel-button").on("click",function(){t.hide(),e=null}),$("#download-image").on("click",function(){$("body").append(f),$(".per-image-download-btn").each((t,e)=>e.click())});function g(t,e={}){if(e.time){const[n,a]=e.time.split(":");t.find(".jam").text(n),t.find(".menit").text(a)}e.date&&(()=>{const[n,a,o]=e.date.split("-");t.find(".column.small-text div").eq(0).text(`${o}-${a}-${n}`)})(),e.day&&t.find(".column.small-text div").eq(1).text(e.day),void 0!==e.location&&t.find(".location-view").text(e.location),void 0!==e.handler&&t.find(".note-view").text(e.handler)}function v(t){const e=t.find(".jam").text(),n=t.find(".menit").text(),[a,o,i]=t.find(".column.small-text div").eq(0).text().split("-");return{time:`${e}:${n}`,date:`${i}-${o}-${a}`,day:t.find(".column.small-text div").eq(1).text(),location:t.find(".location-view").text(),handler:t.find(".note-view").text()}}function y(){return{time:$("#input-time").val()||"00:00",date:$("#input-date").val()||"2000-01-01",day:$("#input-day").val()||"Hari",location:$("#input-location").val()||"Jalan Tanpa Nama",handler:$("#input-handler").val()||"Petugas Patroli"}}const f=$('<div class="spinner-overlay"><div style="display: flex; flex-direction: column; align-items: center;"><div class="spinner"></div><div class="spinner-text">0%</div></div></div>')});